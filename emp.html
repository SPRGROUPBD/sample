<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MPO Portal - Company & QR ID</title>
<!-- External Libraries for QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    /* --- GLOBAL RESETS --- */
    * { box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f9; margin: 0; padding: 0; color: #333; }
    
    /* Top Navigation */
    .top-nav { background: #2c3e50; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-wrap: wrap; position: sticky; top: 0; z-index: 100; }
    .top-nav h2 { margin: 0; font-size: 1.2rem; margin-right: 20px; }
    .container { padding: 15px; max-width: 1200px; margin: auto; padding-bottom: 80px; }
    
    /* Main Tabs */
    .nav-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-left: 5px; transition: 0.3s; font-size: 12px; }
    .nav-btn:hover { background: rgba(255,255,255,0.2); }
    .nav-btn.active { background: #27ae60; color: white; font-weight: bold; }
    
    /* Sections */
    .section { display: none; animation: fadeIn 0.4s; }
    .section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Dashboard Cards */
    .cards { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .card { background: white; padding: 20px; border-radius: 10px; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; min-width: 140px; border-top: 4px solid #2c3e50; }
    .card h2 { margin: 10px 0 5px; font-size: 2rem; color: #2c3e50; }
    .card p { margin: 0; color: #7f8c8d; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }

    /* Forms */
    .form-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; }
    .form-box h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.2rem; }
    .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 250px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px; color: #555; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; transition: 0.3s; }
    input:focus, select:focus { border-color: #27ae60; outline: none; }
    
    .btn { padding: 12px; width: 100%; border: none; color: white; cursor: pointer; border-radius: 6px; font-size: 14px; font-weight: 600; transition: 0.3s; }
    .btn-green { background: #27ae60; }
    .btn-green:hover { background: #219150; }
    .btn-green:disabled { background: #95a5a6; cursor: not-allowed; }
    
    /* Progress Bar Styles */
    .progress-wrapper { margin-top: 15px; display: none; }
    .progress-container { width: 100%; background-color: #e0e0e0; border-radius: 10px; height: 20px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); width: 0%; transition: width 0.2s; text-align: center; line-height: 20px; color: white; font-size: 11px; font-weight: bold; }
    
    /* Table Styling */
    .sub-nav-container { margin-bottom: 15px; display: flex; justify-content: center; gap: 10px; }
    .sub-nav-btn { background: white; border: 1px solid #ddd; padding: 8px 20px; cursor: pointer; font-weight: 600; color: #555; border-radius: 30px; transition: 0.3s; font-size: 13px; }
    .sub-nav-btn.active { background: #2c3e50; color: white; border-color: #2c3e50; }
    
    .table-box { background: white; padding: 10px; border-radius: 10px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
    table { width: 100%; border-collapse: collapse; min-width: 850px; } /* Increased min-width for new column */
    th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
    th { background-color: #f8f9fa; color: #2c3e50; font-weight: 700; text-transform: uppercase; font-size: 11px; white-space: nowrap; }
    tr:hover { background-color: #fcfcfc; }
    
    /* Image & Buttons */
    .user-img { width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 1px solid #eee; }
    .action-btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 10px; font-weight: 600; margin-right: 4px; transition: 0.2s; text-transform: uppercase; text-decoration: none; display: inline-block; text-align: center; line-height: normal;}
    .action-btn:hover { opacity: 0.9; }
    .btn-edit { background: #3498db; }
    .btn-del { background: #e74c3c; }
    .btn-qr { background: #8e44ad; }
    .btn-link { background: #008CBA; } /* New Link Button Style */

    /* Status Badge */
    .status-badge { padding: 3px 10px; border-radius: 15px; font-size: 10px; cursor: pointer; font-weight: bold; display: inline-block; }
    .status-active { background: #d4edda; color: #155724; }
    .status-deactive { background: #f8d7da; color: #721c24; }

    /* Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(4px); }
    .modal-content { background: white; width: 95%; max-width: 500px; margin: 10% auto; padding: 25px; border-radius: 12px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: slideDown 0.3s; max-height: 90vh; overflow-y: auto; }
    @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa; }
    .close-btn:hover { color: #e74c3c; }

    /* QR Modal Specifics */
    #qrcode { display: flex; justify-content: center; margin: 20px 0; }
    #qrcode img { margin: auto; border: 5px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

    /* Scan Section */
    #scan-section { text-align: center; }
    #reader { width: 100%; max-width: 500px; margin: 0 auto; border-radius: 10px; overflow: hidden; }
    .scan-result-box { display: none; margin-top: 20px; animation: fadeIn 0.5s; padding-bottom: 50px; }
    
    /* --- RESPONSIVE ID CARD STYLE --- */
    .id-card-container {
        display: flex;
        justify-content: center;
        padding: 10px;
    }
    .id-card {
        width: 100%; 
        max-width: 360px; 
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        overflow: hidden;
        border: 1px solid #e0e0e0;
        text-align: center;
        position: relative;
        margin: 0 auto; 
    }
    .id-header {
        background: #2c3e50;
        color: white;
        padding: 12px 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .id-header img.company-logo {
        height: 40px;
        width: auto;
        background: white;
        padding: 2px;
        border-radius: 4px;
        object-fit: contain;
    }
    .id-header h4 {
        margin: 0;
        font-size: 14px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .id-body { padding: 20px 15px; }
    .profile-view-img {
        width: 110px;
        height: 110px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #f4f6f9;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }
    .profile-name {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
        line-height: 1.2;
    }
    .profile-deg {
        color: #27ae60;
        font-weight: 600;
        font-size: 13px;
        margin-bottom: 20px;
        background: #eafaf1;
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
    }
    .info-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 12px;
        text-align: left;
        border-bottom: 1px dashed #eee;
        padding-bottom: 5px;
    }
    .info-label { color: #7f8c8d; font-weight: 500; }
    .info-val { color: #2c3e50; font-weight: 700; text-align: right; }
    
    .id-footer {
        background: #f8f9fa;
        padding: 15px;
        border-top: 1px solid #eee;
        text-align: left;
    }
    .footer-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px; font-size: 11px; color: #555; }
    .signature-area {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-top: 10px;
    }
    .sig-img { height: 35px; max-width: 100px; object-fit: contain; }
    .sig-label { font-size: 9px; color: #999; margin-right: 5px; text-transform: uppercase; }

    /* Company Info Upload Section */
    .comp-upload-group { background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #eee; }
    .img-preview-box { max-width: 150px; margin-top: 10px; border: 1px dashed #ccc; padding: 5px; display: none; }
    .img-preview-box img { width: 100%; height: auto; display: block; }

    /* Toast Notification */
    .toast {
        visibility: hidden; min-width: 280px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 13px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* Mobile specific tweaks */
    @media (max-width: 600px) {
        .top-nav { flex-direction: column; align-items: flex-start; gap: 10px; }
        .top-nav div { width: 100%; overflow-x: auto; padding-bottom: 5px; display: flex; }
        .nav-btn { flex: 1; text-align: center; white-space: nowrap; margin-bottom: 5px; }
    }
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>

    <nav class="top-nav" id="mainNav">
        <h2>MPO Portal</h2>
        <div>
            <button class="nav-btn active" onclick="showTab('overview')">Overview</button>
            <button class="nav-btn" onclick="showTab('upload')">New Upload</button>
            <button class="nav-btn" onclick="showTab('view')">View Data</button>
            <button class="nav-btn" onclick="showTab('scan-section')">Scan QR</button>
            <button class="nav-btn" style="background:#e67e22;" onclick="showTab('company-info')">Company Info</button>
        </div>
    </nav>

    <div class="container">
        
        <!-- 1. OVERVIEW -->
        <div id="overview" class="section active">
            <div class="cards">
                <div class="card"><h2 id="stat-total">0</h2><p>Total Employees</p></div>
                <div class="card" style="border-top-color: #27ae60;"><h2 id="stat-active" style="color:#27ae60;">0</h2><p>Active</p></div>
                <div class="card" style="border-top-color: #e74c3c;"><h2 id="stat-deactive" style="color:#e74c3c;">0</h2><p>Deactive</p></div>
            </div>
        </div>

        <!-- 2. UPLOAD FORM -->
        <div id="upload" class="section">
            <div class="form-box">
                <h3>Add New Employee</h3>
                <form id="uploadForm" onsubmit="handleUpload(event)">
                    <div class="form-row">
                        <div class="form-group"><label>EMP Code</label><input type="text" id="upCode" placeholder="Ex: 1001" required></div>
                        <div class="form-group"><label>Name of Employee</label><input type="text" id="upName" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Territory</label><input type="text" id="upTerr" required></div>
                        <div class="form-group"><label>Designation (Deg.)</label>
                            <select id="upDeg" required>
                                <option value="" disabled selected>Select Designation</option>
                                <option value="MPO">MPO (Medical Promotion Officer)</option>
                                <option value="Sr.MPO">Sr. MPO (Senior Medical Promotion Officer)</option>
                                <option value="AM">AM (Area Manager)</option>
                                <option value="ASM">ASM (Area Sales Manager)</option>
                                <option value="Sr.AM">Sr. AM (Senior Area Manager)</option>
                                <option value="RSM">RSM (Regional Sales Manager)</option>
                                <option value="Sr.RSM">Sr. RSM (Senior Regional Sales Manager)</option>
                                <option value="ZSM">ZSM (Zonal Sales Manager)</option>
                                <option value="Depot In-Charge">Depot In-Charge</option>
                                <option value="Asst.Depot In-charge">Asst. Depot In-charge</option>
                                <option value="Delivery Assistant">Delivery Assistant</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Joining Date</label><input type="date" id="upDate" required></div>
                        <div class="form-group"><label>Corporate Mobile No</label><input type="tel" id="upMobile" placeholder="017..." required></div>
                    </div>
                    <div class="form-group" style="margin-bottom:20px;"><label>Profile Image</label><input type="file" id="upFile" accept="image/*" required></div>
                    
                    <div class="progress-wrapper" id="uploadProgressWrapper">
                        <div class="progress-container">
                            <div class="progress-fill" id="uploadProgressBar">0%</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-green" id="btnUpload">Upload & Save</button>
                </form>
            </div>
        </div>

        <!-- 3. VIEW DATA -->
        <div id="view" class="section">
            <div class="sub-nav-container">
                <button class="sub-nav-btn active" id="btnShowActive" onclick="showSubList('active')">Active List</button>
                <button class="sub-nav-btn" id="btnShowDeactive" onclick="showSubList('deactive')">Deactive List</button>
            </div>

            <div id="activeListDiv" class="table-box">
                <h3 style="margin-top:0; color:#27ae60; border-left: 5px solid #27ae60; padding-left: 10px; font-size:16px;">Active Employees</h3>
                <table>
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th width="70">Image</th>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Territory</th>
                            <th>Deg.</th>
                            <th>Mobile</th>
                            <th>Status</th>
                            <th width="50">Link</th> <!-- NEW COLUMN -->
                            <th width="160">Action</th>
                        </tr>
                    </thead>
                    <tbody id="activeBody"></tbody>
                </table>
            </div>

            <div id="deactiveListDiv" class="table-box" style="display:none;">
                <h3 style="margin-top:0; color:#e74c3c; border-left: 5px solid #e74c3c; padding-left: 10px; font-size:16px;">Deactive Employees</h3>
                <table>
                    <thead>
                        <tr>
                            <th width="50">#</th>
                            <th width="70">Image</th>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Territory</th>
                            <th>Deg.</th>
                            <th>Mobile</th>
                            <th>Status</th>
                            <th width="50">Link</th> <!-- NEW COLUMN -->
                            <th width="160">Action</th>
                        </tr>
                    </thead>
                    <tbody id="deactiveBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 4. SCAN QR SECTION -->
        <div id="scan-section" class="section">
            <div class="form-box" style="text-align: center;">
                <h3 id="scanTitle">Scan Employee QR</h3>
                <p id="scanDesc" style="color:#777; margin-bottom:20px; font-size:13px;">Point camera at the QR code to view ID Card.</p>
                <div id="reader"></div>
                <div id="scanResult" class="scan-result-box">
                    <!-- ID Card will be injected here -->
                </div>
            </div>
        </div>

        <!-- 5. COMPANY INFO SECTION -->
        <div id="company-info" class="section">
            <div class="form-box">
                <h3>Company Information Settings</h3>
                <p style="color:#666; font-size:13px; margin-bottom:20px;">Upload logo, signature and contact details for the ID Card view.</p>
                
                <form id="companyForm" onsubmit="handleCompanySave(event)">
                    <div class="comp-upload-group">
                        <label>Company Logo</label>
                        <input type="file" id="compLogo" accept="image/*">
                        <div id="previewLogo" class="img-preview-box"><img src=""></div>
                    </div>

                    <div class="comp-upload-group">
                        <label>Authorized Signature</label>
                        <input type="file" id="compSig" accept="image/*">
                        <div id="previewSig" class="img-preview-box"><img src=""></div>
                    </div>

                    <div class="form-group" style="margin-bottom:15px;">
                        <label>Office Address</label>
                        <input type="text" id="compAddr" placeholder="123 Business Park, City..." required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom:20px;">
                        <label>Contact Tel / Mobile</label>
                        <input type="text" id="compTel" placeholder="+880 1..." required>
                    </div>

                    <div class="progress-wrapper" id="compProgressWrapper">
                        <div class="progress-container">
                            <div class="progress-fill" id="compProgressBar">0%</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-green" id="btnCompSave">Update Information</button>
                </form>
            </div>
        </div>

    </div>

    <!-- EDIT MODAL -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('editModal')">&times;</span>
            <h3 style="color: #2c3e50; font-size: 18px;">Edit Employee Details</h3>
            <form id="editForm" onsubmit="handleEditSave(event)">
                <input type="hidden" id="editKey">
                <div class="form-group" style="margin-bottom:10px;"><label>EMP Code</label><input type="text" id="editCode" required></div>
                <div class="form-group" style="margin-bottom:10px;"><label>Name</label><input type="text" id="editName" required></div>
                <div class="form-group" style="margin-bottom:10px;"><label>Territory</label><input type="text" id="editTerr" required></div>
                <div class="form-group" style="margin-bottom:10px;"><label>Deg.</label>
                    <select id="editDeg" required>
                        <option value="MPO">MPO (Medical Promotion Officer)</option>
                        <option value="Sr.MPO">Sr. MPO (Senior Medical Promotion Officer)</option>
                        <option value="AM">AM (Area Manager)</option>
                        <option value="ASM">ASM (Area Sales Manager)</option>
                        <option value="Sr.AM">Sr. AM (Senior Area Manager)</option>
                        <option value="RSM">RSM (Regional Sales Manager)</option>
                        <option value="Sr.RSM">Sr. RSM (Senior Regional Sales Manager)</option>
                        <option value="ZSM">ZSM (Zonal Sales Manager)</option>
                        <option value="Depot In-Charge">Depot In-Charge</option>
                        <option value="Asst.Depot In-charge">Asst. Depot In-charge</option>
                        <option value="Delivery Assistant">Delivery Assistant</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom:10px;"><label>Joining Date</label><input type="date" id="editDate" required></div>
                <div class="form-group" style="margin-bottom:10px;"><label>Mobile</label><input type="tel" id="editMobile" required></div>
                <div class="form-group" style="margin-bottom:20px; background:#f9f9f9; padding:15px; border:1px dashed #ccc; border-radius:8px;">
                    <label>Update Image (Optional)</label>
                    <input type="file" id="editFile" accept="image/*">
                </div>
                <button type="submit" class="btn btn-green" id="btnEditSave">Update Changes</button>
            </form>
        </div>
    </div>

    <!-- QR CODE MODAL -->
    <div id="qrModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <span class="close-btn" onclick="closeModal('qrModal')">&times;</span>
            <h3 style="color: #8e44ad; font-size: 18px;">Employee QR Code</h3>
            <div id="qrcode"></div>
            <p style="margin-top: 10px; font-size: 13px; color: #555; font-weight: bold;" id="qrNameDisplay"></p>
            <button class="btn btn-green" style="margin-top: 20px; background: #8e44ad;" onclick="closeModal('qrModal')">Close</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Action Successful</div>

    <script>
        // --- CONFIG (Preserving User's Config) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVCQyLO6GG0ylIzYdIij4GfulHWchnVp4",
            authDomain: "livetv-5a773.firebaseapp.com",
            databaseURL: "https://livetv-5a773-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "livetv-5a773",
            storageBucket: "gs://livetv-5a773.appspot.com",
            messagingSenderId: "814020931617",
            appId: "1:814020931617:web:2a5421eb1b7c03e5f67360",
            measurementId: "G-V3ZJKSMT9E"
        };
        
        // Prevent re-initialization
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.database();
        const mpoRef = db.ref('mpo_list');
        const settingsRef = db.ref('company_settings');
        const storage = firebase.storage();

        let employeesCache = {}; 
        let companySettings = {
            logo: 'https://picsum.photos/seed/logo/100/50', 
            signature: 'https://picsum.photos/seed/sig/100/40',
            address: 'Monico Pharma Ltd Head Office',
            tel: '+880 1700000000'
        };

        // --- NEW: URL PARAMETER CHECK ---
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if(id) {
                fetchAndShowCard(id);
            }
        });

        function fetchAndShowCard(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById('scan-section').classList.add('active');
            
            document.getElementById('reader').style.display = 'none';
            document.getElementById('scanTitle').innerText = "Employee ID Card";
            document.getElementById('scanDesc').style.display = 'none';

            mpoRef.child(id).once('value', (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    showIdCard(data);
                } else {
                    document.getElementById('scanResult').innerHTML = '<h3 style="color:red">Employee Not Found</h3><button class="btn btn-green" onclick="window.location.href=window.location.pathname">Go Home</button>';
                    document.getElementById('scanResult').style.display = 'block';
                }
            });
        }

        // --- TOAST FUNCTION ---
        function showToast(message) {
            const x = document.getElementById("toast");
            x.innerText = message;
            x.className = "toast show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        // --- LISTENERS ---
        settingsRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if(data) {
                companySettings = data;
                document.getElementById('compAddr').value = data.address || '';
                document.getElementById('compTel').value = data.tel || '';
                
                if(data.logo) {
                    const prevLogo = document.getElementById('previewLogo');
                    prevLogo.style.display = 'block';
                    prevLogo.querySelector('img').src = data.logo;
                }
                if(data.signature) {
                    const prevSig = document.getElementById('previewSig');
                    prevSig.style.display = 'block';
                    prevSig.querySelector('img').src = data.signature;
                }
            }
        });

        // Get base URL for links
        const baseUrl = window.location.href.split('?')[0];

        mpoRef.on('value', (snapshot) => {
            const data = snapshot.val();
            const actBody = document.getElementById('activeBody');
            const deactBody = document.getElementById('deactiveBody');
            actBody.innerHTML = ""; deactBody.innerHTML = "";
            employeesCache = {}; 
            
            let t=0, a=0, d=0;

            if(data) {
                let i = 1;
                Object.keys(data).forEach(key => {
                    const item = data[key];
                    employeesCache[key] = item; 
                    
                    t++;
                    const status = item.status || 'Active';
                    if(status === 'Active') a++; else d++;

                    const img = item.url ? `<img src="${item.url}" class="user-img">` : '<div style="width:40px;height:40px;background:#eee;border-radius:50%;display:inline-block"></div>';
                    const actionBadge = `<span class="status-badge ${status==='Active'?'status-active':'status-deactive'}" onclick="toggleStatus('${key}', '${status}')">${status}</span>`;

                    // --- NEW LINK LOGIC ---
                    const shareLink = baseUrl + "?id=" + key;
                    const linkBtn = `<a href="${shareLink}" target="_blank" class="action-btn btn-link">Link</a>`;

                    const row = `
                        <tr>
                            <td>${i++}</td>
                            <td>${img}</td>
                            <td>${item.code}</td>
                            <td>${item.name}</td>
                            <td>${item.territory}</td>
                            <td><small>${item.deg}</small></td>
                            <td>${item.mobile}</td>
                            <td>${actionBadge}</td>
                            <td>${linkBtn}</td> <!-- LINK COLUMN -->
                            <td>
                                <button class="action-btn btn-qr" onclick="generateQR('${key}')" title="View QR">QR</button>
                                <button class="action-btn btn-edit" onclick="openEdit('${key}')">Edit</button>
                                <button class="action-btn btn-del" onclick="deleteItem('${key}')">Del</button>
                            </td>
                        </tr>`;

                    if(status === 'Active') actBody.innerHTML += row;
                    else deactBody.innerHTML += row;
                });
            }
            document.getElementById('stat-total').innerText = t;
            document.getElementById('stat-active').innerText = a;
            document.getElementById('stat-deactive').innerText = d;
        });

        // --- COMPANY INFO SAVE ---
        function handleCompanySave(e) {
            e.preventDefault();
            const logoFile = document.getElementById('compLogo').files[0];
            const sigFile = document.getElementById('compSig').files[0];
            const btn = document.getElementById('btnCompSave');
            const pWrapper = document.getElementById('compProgressWrapper');
            const pBar = document.getElementById('compProgressBar');

            btn.disabled = true;
            pWrapper.style.display = 'block';
            pBar.style.width = '0%';

            const updateObj = {
                address: document.getElementById('compAddr').value,
                tel: document.getElementById('compTel').value
            };

            let uploadsDone = 0;
            let totalUploads = 0;
            if(logoFile) totalUploads++;
            if(sigFile) totalUploads++;

            const finishSave = () => {
                settingsRef.update(updateObj).then(() => {
                    showToast("Company Info Updated!");
                    pWrapper.style.display = 'none';
                }).catch(err => showToast("Error: " + err.message))
                .finally(() => btn.disabled = false);
            };

            const processUpload = (file, key) => {
                const task = storage.ref('company_uploads/' + Date.now() + file.name).put(file);
                task.on('state_changed', s => {
                    const progress = (s.bytesTransferred / s.totalBytes) * 100;
                    pBar.style.width = progress + '%';
                }, err => {
                    showToast("Upload Error: " + err.message);
                    btn.disabled = false;
                }, () => {
                    task.snapshot.ref.getDownloadURL().then(url => {
                        updateObj[key] = url;
                        uploadsDone++;
                        if(uploadsDone === totalUploads) finishSave();
                        else if(uploadsDone === 0 && totalUploads === 0) finishSave();
                    });
                });
            };

            if(logoFile) processUpload(logoFile, 'logo');
            if(sigFile) processUpload(sigFile, 'signature');
            
            if(totalUploads === 0) {
                pBar.style.width = '100%';
                setTimeout(finishSave, 500);
            }
        }

        // --- QR GENERATION ---
        function generateQR(key) {
            const item = employeesCache[key];
            if(!item) return;

            const modal = document.getElementById('qrModal');
            const qrContainer = document.getElementById('qrcode');
            const nameDisplay = document.getElementById('qrNameDisplay');
            
            qrContainer.innerHTML = ""; 
            nameDisplay.innerText = item.name;
            modal.style.display = 'block';

            const qrData = JSON.stringify({
                id: key,
                code: item.code,
                name: item.name,
                territory: item.territory,
                deg: item.deg,
                date: item.date,
                mobile: item.mobile,
                url: item.url,
                status: item.status
            });

            new QRCode(qrContainer, {
                text: qrData,
                width: 200,
                height: 200,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        }

        // --- SCANNER LOGIC ---
        let html5QrcodeScanner;
        
        function onScanSuccess(decodedText, decodedResult) {
            if(html5QrcodeScanner) {
                html5QrcodeScanner.clear();
                html5QrcodeScanner = null; 
            }
            
            try {
                const data = JSON.parse(decodedText);
                showIdCard(data);
            } catch (e) {
                showToast("Invalid QR Code format");
                console.error(e);
                resetScanner();
            }
        }

        function showIdCard(data) {
            const container = document.getElementById('scanResult');
            const statusColor = data.status === 'Active' ? '#27ae60' : '#e74c3c';
            const imgUrl = data.url || 'https://picsum.photos/seed/'+data.code+'/200/200';
            
            const compLogo = companySettings.logo || '';
            const compSig = companySettings.signature || '';
            const compAddr = companySettings.address || 'N/A';
            const compTel = companySettings.tel || 'N/A';

            const html = `
                <div class="id-card-container">
                    <div class="id-card">
                        <div class="id-header">
                            ${compLogo ? `<img src="${compLogo}" class="company-logo" alt="Logo">` : ''}
                            <h4>Monico Pharma Ltd</h4>
                            <div style="width: 40px;"></div>
                        </div>
                        
                        <div class="id-body">
                            <img src="${imgUrl}" class="profile-view-img" alt="Profile">
                            <div class="profile-name">${data.name}</div>
                            <div class="profile-deg">${data.deg}</div>
                            
                            <div class="info-row">
                                <span class="info-label">Code:</span>
                                <span class="info-val">${data.code}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Territory:</span>
                                <span class="info-val">${data.territory}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Mobile:</span>
                                <span class="info-val">${data.mobile}</span>
                            </div>
                             <div class="info-row">
                                <span class="info-label">Joining:</span>
                                <span class="info-val">${data.date || 'N/A'}</span>
                            </div>
                            <div class="info-row" style="border:none; margin-top:15px; justify-content:center;">
                                <span style="font-size:11px; padding:4px 12px; border-radius:12px; background:${statusColor}; color:white;">${data.status}</span>
                            </div>
                        </div>

                        <div class="id-footer">
                            <div class="footer-grid">
                                <div><strong>Address:</strong> ${compAddr}</div>
                                <div><strong>Tel:</strong> ${compTel}</div>
                            </div>
                            <div class="signature-area">
                                <span class="sig-label">Authorized Signature</span>
                                ${compSig ? `<img src="${compSig}" class="sig-img">` : '<span style="font-style:italic; font-size:12px; color:#ccc;">[Sign Here]</span>'}
                            </div>
                        </div>
                    </div>
                </div>
                <button class="btn btn-green" style="max-width:200px; margin: 20px auto 0; display:block; background:#2c3e50; border-radius:50px;" onclick="window.location.href=window.location.pathname">Back to Home</button>
            `;
            container.innerHTML = html;
            container.style.display = 'block';
        }

        function resetScanner() {
            const container = document.getElementById('scanResult');
            container.style.display = 'none';
            container.innerHTML = '';
            document.getElementById('scanTitle').innerText = "Scan Employee QR";
            document.getElementById('scanDesc').style.display = 'block';
            document.getElementById('reader').style.display = 'block';
            initScanner();
        }

        function initScanner() {
            setTimeout(() => {
                html5QrcodeScanner = new Html5QrcodeScanner(
                    "reader",
                    { fps: 10, qrbox: {width: 250, height: 250} },
                    false);
                html5QrcodeScanner.render(onScanSuccess, (errorMessage) => {
                    // parse error, ignore
                });
            }, 500);
        }

        // --- UPLOAD EMPLOYEE ---
        function handleUpload(e) {
            e.preventDefault();
            const file = document.getElementById('upFile').files[0];
            if(!file) return showToast("Select a photo first!");
            
            const btn = document.getElementById('btnUpload');
            const progressWrapper = document.getElementById('uploadProgressWrapper');
            const progressBar = document.getElementById('uploadProgressBar');

            btn.disabled = true;
            progressWrapper.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.innerText = '0%';

            const uploadTask = storage.ref('mpo_images/' + Date.now() + "_" + file.name).put(file);

            uploadTask.on('state_changed', (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = progress + '%';
                progressBar.innerText = Math.floor(progress) + '%';
            }, (error) => {
                showToast("Upload Error: " + error.message);
                btn.disabled = false;
                progressWrapper.style.display = 'none';
            }, () => {
                uploadTask.snapshot.ref.getDownloadURL().then((url) => {
                    const data = {
                        code: document.getElementById('upCode').value,
                        name: document.getElementById('upName').value,
                        territory: document.getElementById('upTerr').value,
                        deg: document.getElementById('upDeg').value,
                        date: document.getElementById('upDate').value,
                        mobile: document.getElementById('upMobile').value,
                        url: url,
                        status: 'Active'
                    };
                    return mpoRef.push(data);
                }).then((ref) => {
                    const uniqueLink = baseUrl + "?id=" + ref.key;
                    window.prompt("Employee Saved! Copy the link below to view ID Card:", uniqueLink);
                    
                    showToast("Saved Successfully!");
                    document.getElementById('uploadForm').reset();
                    progressWrapper.style.display = 'none';
                    showTab('view');
                }).catch(err => showToast("DB Error: " + err.message))
                .finally(() => btn.disabled = false);
            });
        }

        // --- EDIT EMPLOYEE ---
        function openEdit(key) {
            const item = employeesCache[key];
            if(!item) return;

            document.getElementById('editKey').value = key;
            document.getElementById('editCode').value = item.code;
            document.getElementById('editName').value = item.name;
            document.getElementById('editTerr').value = item.territory;
            document.getElementById('editDeg').value = item.deg;
            document.getElementById('editDate').value = item.date || '';
            document.getElementById('editMobile').value = item.mobile;
            document.getElementById('editModal').style.display = 'block';
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function handleEditSave(e) {
            e.preventDefault();
            const key = document.getElementById('editKey').value;
            const file = document.getElementById('editFile').files[0];
            document.getElementById('btnEditSave').disabled = true;

            const updates = {
                code: document.getElementById('editCode').value,
                name: document.getElementById('editName').value,
                territory: document.getElementById('editTerr').value,
                deg: document.getElementById('editDeg').value,
                date: document.getElementById('editDate').value,
                mobile: document.getElementById('editMobile').value
            };

            const finish = (obj) => {
                mpoRef.child(key).update(obj)
                .then(() => { closeModal('editModal'); showToast("Updated Successfully!"); })
                .catch(err => showToast("Error: "+err.message))
                .finally(() => document.getElementById('btnEditSave').disabled = false);
            };

            if(file) {
                storage.ref('mpo_images/' + Date.now() + "_" + file.name).put(file)
                .then(snap => snap.ref.getDownloadURL())
                .then(url => { updates.url = url; finish(updates); });
            } else { finish(updates); }
        }

        // --- UTILS ---
        function toggleStatus(key, cur) {
            const next = (cur === 'Active') ? 'Deactive' : 'Active';
            if(confirm("Change status to " + next + "?")) {
                mpoRef.child(key).update({ status: next }).then(()=>showToast("Status Updated"));
            }
        }
        function deleteItem(key) { 
            if(confirm("Are you sure you want to delete this record?")) {
                mpoRef.child(key).remove().then(()=>showToast("Deleted Successfully"));
            } 
        }
        function showTab(id) {
            if(id !== 'scan-section') {
                 document.getElementById('reader').style.display = 'none';
                 document.getElementById('scanTitle').innerText = "Scan Employee QR";
                 document.getElementById('scanDesc').style.display = 'block';
                 document.getElementById('scanResult').style.display = 'none';
                 if(html5QrcodeScanner) {
                    try { html5QrcodeScanner.clear(); html5QrcodeScanner = null; } catch(e){}
                 }
            }

            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => b.classList.remove('active'));
            
            const map = {'overview':0, 'upload':1, 'view':2, 'scan-section':3, 'company-info':4};
            if(map[id] !== undefined) btns[map[id]].classList.add('active');

            if(id === 'scan-section') {
                if(document.getElementById('reader').style.display === 'none') {
                    // Do nothing
                } else {
                    document.getElementById('reader').style.display = 'block';
                    initScanner();
                }
            }
        }
        function showSubList(type) {
            const actDiv = document.getElementById('activeListDiv');
            const deactDiv = document.getElementById('deactiveListDiv');
            const bAct = document.getElementById('btnShowActive');
            const bDeact = document.getElementById('btnShowDeactive');
            
            if(type === 'active') {
                actDiv.style.display = 'block'; deactDiv.style.display = 'none';
                bAct.classList.add('active'); bDeact.classList.remove('active');
            } else {
                actDiv.style.display = 'none'; deactDiv.style.display = 'block';
                bAct.classList.remove('active'); bDeact.classList.add('active');
            }
        }
        window.onclick = function(e) { 
            if(e.target.classList.contains('modal')) e.target.style.display = 'none'; 
        }
    </script>
</body>
</html>
