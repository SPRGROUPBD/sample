<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MONICOPHARMA Bill System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; font-size: 14px; }
        .login-container { max-width: 400px; margin: 100px auto; }
        
        /* Status Styles */
        .status-red { background-color: #ffebee; border-left: 5px solid #ef5350; }
        .status-green { background-color: #e8f5e9; border-left: 5px solid #66bb6a; }
        .status-draft { background-color: #fff3e0; border-left: 5px solid #ffa726; }
        .hidden { display: none; }
        
        /* Mobile Responsive Table */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        
        /* Print Style */
        .print-container { display: none; }
        @media print {
            body * { visibility: hidden; }
            .print-container, .print-container * { visibility: visible; }
            .print-container { 
                position: absolute; left: 0; top: 0; width: 100%; display: block; 
                padding: 10px; font-size: 11px;
            }
            .no-print { display: none !important; }
            #pageFooter {
                position: fixed; bottom: 10px; left: 0; width: 100%; text-align: center; font-size: 12px;
            }
            #pageFooter:after { content: "PAGE : " counter(page); }
            thead { display: table-header-group; }
            tfoot { display: table-footer-group; }
            table, th, td { border: 1px solid #000 !important; border-collapse: collapse; }
            th, td { padding: 2px 4px; font-size: 11px; line-height: 1.2; }
            .sign-row td { height: 50px; vertical-align: bottom; }
        }

        /* Custom Styles */
        .cut-amount { color: red; text-decoration: line-through; margin-right: 8px; font-weight: bold; }
        .payable-amount { color: green; font-weight: bold; }
        
        /* Compact styling for mobile */
        @media (max-width: 768px) {
            .btn-sm { font-size: 0.7rem; padding: 0.25rem 0.5rem; }
            .form-control, .form-select { font-size: 0.85rem; }
            h3 { font-size: 1.2rem; }
            h5 { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Login Section -->
    <div id="login_section" class="container login-container">
        <div class="card shadow-lg">
            <div class="card-header bg-primary text-white text-center">
                <h4>Bill Management Login</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label>Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter Username">
                </div>
                <div class="mb-3">
                    <label>Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter Password">
                </div>
                <button onclick="handleLogin()" class="btn btn-primary w-100">Login</button>
                <small class="text-muted d-block mt-2 text-center">Admin: KS / Monico@Ku007</small>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard_section" class="container-fluid mt-2 hidden"> <!-- Changed to container-fluid for better fit -->
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light shadow-sm rounded no-print">
            <h5 class="mb-0" id="welcome_msg">Welcome</h5>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>

        <!-- Nav Tabs -->
        <ul class="nav nav-tabs no-print" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="entry-tab" data-bs-toggle="tab" data-bs-target="#entryTab" type="button">Bill Entry</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#billTab" type="button">History</button>
            </li>
            <li class="nav-item admin-only" role="presentation">
                <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#addTab" type="button">Add DA</button>
            </li>
        </ul>

        <div class="tab-content pt-2">
            
            <!-- Tab 1: USER BILL ENTRY FORM -->
            <div class="tab-pane fade show active" id="entryTab" role="tabpanel">
                <div class="bill-form-container no-print">
                    <div class="text-center mb-2">
                        <h3>MONICOPHARMA</h3>
                        <h5>Delivery Expense Bill</h5>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-4"><label class="fw-bold">Name Of DA:</label><input type="text" id="form_da_name" class="form-control form-control-sm" readonly></div>
                        <div class="col-4"><label class="fw-bold">Designation:</label><input type="text" value="Delivery Assistant" class="form-control form-control-sm" readonly></div>
                        <div class="col-4"><label class="fw-bold">Depot:</label><input type="text" id="form_depot" class="form-control form-control-sm" readonly></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><label class="fw-bold">Departure Date:</label><input type="date" id="form_dep_date" class="form-control form-control-sm"></div>
                        <div class="col-6"><label class="fw-bold">Return Date:</label><input type="date" id="form_ret_date" class="form-control form-control-sm"></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-12"><label class="fw-bold">Route:</label><input type="text" id="form_route" class="form-control form-control-sm" placeholder="Route Name"></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-6"><label class="fw-bold">Name of MPO:</label><input type="text" id="form_mpo" class="form-control form-control-sm"></div>
                        <div class="col-6"><label class="fw-bold">Summary No:</label><input type="text" id="form_summary" class="form-control form-control-sm"></div>
                    </div>

                    <div class="row mb-2">
                        <div class="col-4"><label>Invoice Value:</label><input type="number" id="form_invoice_val" class="form-control form-control-sm" oninput="calculateSoldValue()"></div>
                        <div class="col-4"><label>Return Value:</label><input type="number" id="form_return_val" class="form-control form-control-sm" value="0" oninput="calculateSoldValue()"></div>
                        <div class="col-4"><label>Sold Value:</label><input type="number" id="form_sold_val" class="form-control form-control-sm" readonly></div>
                    </div>
                    
                    <div class="row mb-2">
                        <div class="col-6"><label>Invoice Qty:</label><input type="number" id="form_invoice_qty" class="form-control form-control-sm"></div>
                    </div>

                    <!-- Expense Table -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th><th>From</th><th>To</th><th>Mode</th><th>Amount</th><th>DA</th><th>Total</th><th>X</th>
                                </tr>
                            </thead>
                            <tbody id="expense_table_body"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-end fw-bold">Grand Total:</td>
                                    <td colspan="3"><input type="text" id="grand_total" class="form-control form-control-sm fw-bold text-center" value="0" readonly></td>
                                </tr>
                                <tr class="table-info">
                                    <td colspan="4" class="text-end fw-bold">Cost (%):</td>
                                    <td colspan="3"><span id="form_cost_percent" class="fw-bold">0%</span></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-2">
                        <button onclick="addExpenseRow()" class="btn btn-secondary btn-sm">+ Row</button>
                        <button id="draft_btn" onclick="submitOrUpdateBill('draft')" class="btn btn-secondary btn-sm">Save Draft</button>
                        <button id="main_submit_btn" onclick="submitOrUpdateBill('red')" class="btn btn-success btn-sm">Submit Bill</button>
                        <button id="cancel_edit_btn" onclick="cancelEdit()" class="btn btn-danger btn-sm hidden">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Bill History -->
            <div class="tab-pane fade" id="billTab" role="tabpanel">
                <div class="card no-print">
                    <div class="card-body p-1">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover table-sm">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Date</th><th>DA Name</th><th>Depot</th><th>Route</th><th>Amount</th><th>Status</th><th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="bill_table_body"><tr><td colspan="7" class="text-center">Loading...</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Add New DA -->
            <div class="tab-pane fade admin-only" id="addTab" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-info text-white py-1">New DA Record</div>
                    <div class="card-body">
                         <div class="row g-2">
                            <div class="col-6"><label>DA ID</label><input type="text" id="new_da_id" class="form-control form-control-sm"></div>
                            <div class="col-6"><label>Name</label><input type="text" id="new_da_name" class="form-control form-control-sm"></div>
                            <div class="col-6"><label>Phone</label><input type="text" id="new_da_phone" class="form-control form-control-sm"></div>
                            <div class="col-6"><label>Depot</label><input type="text" id="new_da_depot" class="form-control form-control-sm" value="Kushtia"></div>
                            <div class="col-6"><label>Username</label><input type="text" id="new_da_user" class="form-control form-control-sm"></div>
                            <div class="col-6"><label>Password</label><input type="text" id="new_da_pass" class="form-control form-control-sm"></div>
                            <div class="col-12"><button onclick="saveNewDA()" class="btn btn-success w-100 btn-sm">Save Record</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cut Bill Modal (Admin Only) -->
    <div class="modal fade no-print" id="cutBillModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning py-1">
                    <h5 class="modal-title">Bill Deduction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-2">
                    <input type="hidden" id="edit_bill_id">
                    <input type="hidden" id="edit_depot">
                    <div class="table-responsive">
                        <table class="table table-sm modal-table table-bordered">
                            <thead class="table-secondary text-center">
                                <tr><th>Date</th><th>From</th><th>To</th><th>Mode</th><th>Amount</th><th>DA</th><th>Deduction</th><th>Total</th></tr>
                            </thead>
                            <tbody id="modal_expense_body"></tbody>
                            <tfoot>
                                <tr class="table-light fw-bold">
                                    <td colspan="7" class="text-end">Total Payable:</td>
                                    <td class="text-center text-success" id="modal_grand_total">0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="modal-footer py-1">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                    <button onclick="saveDeduction()" type="button" class="btn btn-success btn-sm">Approve Payment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PRINT CONTAINER -->
    <div class="print-container" id="print_area">
        <!-- Main Header -->
        <div style="text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px;">
            <h2 style="margin:0; letter-spacing: 2px;">MONICOPHARMA</h2>
            <h4 style="margin:0; text-decoration: underline;">Delivery Expense Bill</h4>
        </div>

        <!-- Info Table -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
            <tr>
                <td style="width:33.33%; text-align: left; padding: 3px;"><strong>Name Of DA:</strong> <span id="p_da_name"></span></td>
                <td style="width:33.33%; text-align: center; padding: 3px;"><strong>Designation:</strong> Delivery Assistant</td>
                <td style="width:33.33%; text-align: right; padding: 3px;"><strong>Depot:</strong> <span id="p_depot"></span></td>
            </tr>
            <!-- Updated Layout as requested -->
            <tr>
                <td style="text-align: left; padding: 3px;"><strong>Departure Date:</strong> <span id="p_dep_date"></span></td>
                <td style="text-align: center; padding: 3px;"><strong>Return Date:</strong> <span id="p_ret_date"></span></td>
                <td style="text-align: right; padding: 3px;"><strong>Bill Date:</strong> <span id="p_submit_date"></span></td>
            </tr>
            <tr>
                <td colspan="3" style="text-align: left; padding: 3px;"><strong>Route:</strong> <span id="p_route"></span></td>
            </tr>
            <tr>
                <td colspan="3" style="text-align: left; padding: 3px;"><strong>Name of MPO:</strong> <span id="p_mpo"></span></td>
            </tr>
            <tr>
                <td style="text-align: left; padding: 3px;"><strong>Summary No:</strong> <span id="p_summary"></span></td>
                <td colspan="2" style="text-align: center; padding: 3px;"><strong>Invoice Value:</strong> <span id="p_inv_val"></span></td>
            </tr>
            <tr>
                <td style="text-align: left; padding: 3px;"><strong>Return Value:</strong> <span id="p_ret_val"></span></td>
                <td style="text-align: center; padding: 3px;"><strong>Sold Value:</strong> <span id="p_sold_val"></span></td>
                <td style="text-align: right; padding: 3px;"><strong>Invoice Qty:</strong> <span id="p_inv_qty"></span></td>
            </tr>
        </table>

        <!-- Main Expense Table -->
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
            <thead>
                <tr style="background-color: #f0f0f0;">
                    <th style="padding: 2px; text-align: left;">Date</th>
                    <th style="padding: 2px; text-align: left;">From</th>
                    <th style="padding: 2px; text-align: left;">To</th>
                    <th style="padding: 2px; text-align: left;">Mode</th>
                    <th style="padding: 2px; text-align: left;">Amount</th>
                    <th style="padding: 2px; text-align: left;">DA</th>
                    <th style="padding: 2px; text-align: left;">Deduction</th>
                    <th style="padding: 2px; text-align: left;">Total</th>
                </tr>
            </thead>
            <tbody id="p_expense_body"></tbody>
            <tfoot>
                <tr>
                    <td colspan="7" style="text-align:right; padding: 2px;"><strong>Total</strong></td>
                    <td style="text-align:left; padding: 2px;"><strong id="p_total_amount"></strong></td>
                </tr>
            </tfoot>
        </table>

        <!-- Total In Words Section -->
        <div style="margin-top: 5px; border: 1px solid #000; padding: 3px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between;">
                <div style="width: 60%;"><strong>Total In Words:</strong> <span id="p_total_words"></span></div>
                <div style="width: 35%; text-align: right;"><strong>Cost (%):</strong> <span id="p_cost_percent"></span></div>
            </div>
        </div>

        <!-- Signature Section -->
        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
            <tr class="sign-row">
                <td style="width: 25%; text-align: center; vertical-align: bottom; font-weight: bold;"><span id="p_prepared_by"></span></td>
                <td style="width: 25%; text-align: center; vertical-align: bottom;"></td>
                <td style="width: 25%; text-align: center; vertical-align: bottom;"></td>
                <td style="width: 25%; text-align: center; vertical-align: bottom;"></td>
            </tr>
            <tr>
                <td style="width: 25%; text-align: center;">Prepared By</td>
                <td style="width: 25%; text-align: center;">Checked By DIC</td>
                <td style="width: 25%; text-align: center;">ReChecked By RSM</td>
                <td style="width: 25%; text-align: center;">Approved By</td>
            </tr>
        </table>
        <div id="pageFooter"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // ================= FIREBASE CONFIGURATION =================
        const firebaseConfig = {
            apiKey: "AIzaSyBEaGG_UsXGf6RGHQ_ckalf33fLla-P2J8",
            authDomain: "whatapp-8d8ed.firebaseapp.com",
            databaseURL: "https://whatapp-8d8ed-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "whatapp-8d8ed",
            storageBucket: "whatapp-8d8ed.firebasestorage.app",
            messagingSenderId: "618833956157",
            appId: "1:618833956157:web:2c3835d5c03668afa7c954",
            measurementId: "G-JLG1K25Z7N"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentUser = null;
        let editingBillId = null;

        // ================= DATE FORMATTER (DD-MM-YYYY) =================
        function formatDate(dateStr) {
            if (!dateStr) return '';
            if (dateStr.indexOf('-') !== 4) return dateStr; 
            const parts = dateStr.split('-');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        // ================= LOGIN LOGIC =================
        function handleLogin() {
            const userVal = document.getElementById('username').value;
            const passVal = document.getElementById('password').value;

            if (userVal === 'KS' && passVal === 'Monico@Ku007') {
                currentUser = { name: 'Admin', role: 'admin', depot: 'all', id: 'admin_001' };
                showDashboard();
                return;
            }

            const userRef = database.ref('Users');
            userRef.orderByChild('username').equalTo(userVal).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        if (userData.password === passVal) {
                            currentUser = {
                                name: userData.name,
                                role: 'user',
                                depot: userData.depot,
                                id: childSnapshot.key
                            };
                            showDashboard();
                        } else {
                            alert("Password Incorrect!");
                        }
                    });
                } else {
                    alert("User not found!");
                }
            });
        }

        function logout() { currentUser = null; location.reload(); }

        // ================= DASHBOARD VIEW =================
        function showDashboard() {
            document.getElementById('login_section').classList.add('hidden');
            document.getElementById('dashboard_section').classList.remove('hidden');
            
            document.getElementById('welcome_msg').innerText = `Welcome: ${currentUser.name}`;
            
            if(currentUser.role !== 'admin') {
                document.querySelectorAll('.admin-only').forEach(item => item.style.display = 'none');
            } else {
                 document.getElementById('entry-tab').classList.remove('active');
                 document.getElementById('entryTab').classList.remove('show', 'active');
                 document.getElementById('history-tab').classList.add('active');
                 document.getElementById('billTab').classList.add('show', 'active');
            }

            prepareBillEntryForm();
            loadBills();
        }

        // ================= BILL ENTRY LOGIC =================
        function prepareBillEntryForm() {
            if(currentUser.role === 'admin') return;
            
            document.getElementById('form_da_name').value = currentUser.name;
            document.getElementById('form_depot').value = currentUser.depot;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('form_dep_date').value = today;
            document.getElementById('form_ret_date').value = today;

            document.getElementById('expense_table_body').innerHTML = '';
            addExpenseRow();
        }

        function calculateSoldValue() {
            const inv = parseFloat(document.getElementById('form_invoice_val').value) || 0;
            const ret = parseFloat(document.getElementById('form_return_val').value) || 0;
            document.getElementById('form_sold_val').value = inv - ret;
            updateEntryFormCostPercent();
        }

        function addExpenseRow() {
            const tbody = document.getElementById('expense_table_body');
            const today = new Date().toISOString().split('T')[0];
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="date" class="form-control form-control-sm exp-date" value="${today}"></td>
                <td><input type="text" class="form-control form-control-sm exp-from"></td>
                <td><input type="text" class="form-control form-control-sm exp-to"></td>
                <td><select class="form-select form-select-sm exp-mode"><option>Bus</option><option>Rick</option><option>CNG</option></select></td>
                <td><input type="number" class="form-control form-control-sm exp-amount" oninput="calculateRowTotal(this)"></td>
                <td><input type="number" class="form-control form-control-sm exp-da" oninput="calculateRowTotal(this)"></td>
                <td><input type="text" class="form-control form-control-sm exp-total" readonly></td>
                <td><button class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
            `;
        }

        function removeRow(btn) { btn.parentNode.parentNode.remove(); calculateGrandTotal(); }

        function calculateRowTotal(input) {
            const row = input.parentNode.parentNode;
            const amount = parseFloat(row.querySelector('.exp-amount').value) || 0;
            const da = parseFloat(row.querySelector('.exp-da').value) || 0;
            row.querySelector('.exp-total').value = amount + da;
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let total = 0;
            document.querySelectorAll('.exp-total').forEach(t => total += (parseFloat(t.value) || 0));
            document.getElementById('grand_total').value = total;
            updateEntryFormCostPercent();
        }

        function updateEntryFormCostPercent() {
            const inv = parseFloat(document.getElementById('form_invoice_val').value) || 0;
            const total = parseFloat(document.getElementById('grand_total').value) || 0;
            let percent = "0%";
            if (inv > 0) percent = ((total / inv) * 100).toFixed(2) + "%";
            document.getElementById('form_cost_percent').innerText = percent;
        }

        // ================= SUBMIT, UPDATE, DRAFT LOGIC =================
        function submitOrUpdateBill(statusType) {
            const billData = {
                daName: currentUser.name,
                daId: currentUser.id,
                depot: currentUser.depot,
                depDate: document.getElementById('form_dep_date').value,
                retDate: document.getElementById('form_ret_date').value,
                route: document.getElementById('form_route').value,
                mpo: document.getElementById('form_mpo').value,
                summaryNo: document.getElementById('form_summary').value,
                invoiceVal: parseFloat(document.getElementById('form_invoice_val').value) || 0,
                returnVal: parseFloat(document.getElementById('form_return_val').value) || 0,
                soldVal: parseFloat(document.getElementById('form_sold_val').value) || 0,
                invoiceQty: parseInt(document.getElementById('form_invoice_qty').value) || 0,
                totalAmount: parseFloat(document.getElementById('grand_total').value),
                status: statusType, // 'red' for submit, 'draft' for draft
                timestamp: Date.now()
            };

            let expenses = [];
            document.querySelectorAll('#expense_table_body tr').forEach(r => {
                expenses.push({
                    date: r.querySelector('.exp-date').value,
                    from: r.querySelector('.exp-from').value,
                    to: r.querySelector('.exp-to').value,
                    mode: r.querySelector('.exp-mode').value,
                    amount: r.querySelector('.exp-amount').value,
                    da: r.querySelector('.exp-da').value
                });
            });
            billData.expenses = expenses;

            if (!billData.route) { alert("Please fill Route"); return; }

            // Database Path: Bills/Depot/DA_ID/Bill_ID
            const basePath = 'Bills/' + billData.depot + '/' + currentUser.id;
            
            if (editingBillId) {
                database.ref(basePath + '/' + editingBillId).update(billData, (error) => {
                    if (error) alert("Update Error");
                    else {
                        alert("Bill Updated!");
                        cancelEdit();
                        document.getElementById('history-tab').click();
                    }
                });
            } else {
                const newBillRef = database.ref(basePath).push();
                newBillRef.set(billData, (error) => {
                    if (error) alert("Error");
                    else {
                        alert(statusType === 'draft' ? "Saved as Draft!" : "Bill Submitted!");
                        document.getElementById('form_route').value = '';
                        document.getElementById('grand_total').value = '0';
                        document.getElementById('form_cost_percent').innerText = '0%';
                        prepareBillEntryForm();
                        document.getElementById('history-tab').click();
                    }
                });
            }
        }

        function editBill(billId, depot, daId) {
            // Path: Bills/Depot/DA_ID/Bill_ID
            database.ref('Bills/' + depot + '/' + daId + '/' + billId).once('value', (snapshot) => {
                const bill = snapshot.val();
                if(!bill) return;

                document.getElementById('form_da_name').value = bill.daName;
                document.getElementById('form_depot').value = bill.depot;
                document.getElementById('form_dep_date').value = bill.depDate;
                document.getElementById('form_ret_date').value = bill.retDate;
                document.getElementById('form_route').value = bill.route;
                document.getElementById('form_mpo').value = bill.mpo;
                document.getElementById('form_summary').value = bill.summaryNo;
                document.getElementById('form_invoice_val').value = bill.invoiceVal;
                document.getElementById('form_return_val').value = bill.returnVal;
                document.getElementById('form_invoice_qty').value = bill.invoiceQty;
                
                const tbody = document.getElementById('expense_table_body');
                tbody.innerHTML = '';
                if(bill.expenses) {
                    bill.expenses.forEach(exp => {
                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><input type="date" class="form-control form-control-sm exp-date" value="${exp.date}"></td>
                            <td><input type="text" class="form-control form-control-sm exp-from" value="${exp.from}"></td>
                            <td><input type="text" class="form-control form-control-sm exp-to" value="${exp.to}"></td>
                            <td><select class="form-select form-select-sm exp-mode"><option ${exp.mode == 'Bus' ? 'selected' : ''}>Bus</option><option ${exp.mode == 'Rick' ? 'selected' : ''}>Rick</option><option ${exp.mode == 'CNG' ? 'selected' : ''}>CNG</option></select></td>
                            <td><input type="number" class="form-control form-control-sm exp-amount" value="${exp.amount}" oninput="calculateRowTotal(this)"></td>
                            <td><input type="number" class="form-control form-control-sm exp-da" value="${exp.da}" oninput="calculateRowTotal(this)"></td>
                            <td><input type="text" class="form-control form-control-sm exp-total" value="${(parseFloat(exp.amount)||0) + (parseFloat(exp.da)||0)}" readonly></td>
                            <td><button class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
                        `;
                    });
                }

                calculateGrandTotal();
                calculateSoldValue();

                editingBillId = billId;
                document.getElementById('main_submit_btn').innerText = "Update Bill";
                document.getElementById('main_submit_btn').classList.remove('btn-success');
                document.getElementById('main_submit_btn').classList.add('btn-warning');
                document.getElementById('cancel_edit_btn').classList.remove('hidden');
                document.getElementById('entry-tab').click();
            });
        }

        function deleteBill(billId, depot, daId) {
            if(confirm("Are you sure you want to delete this bill?")) {
                database.ref('Bills/' + depot + '/' + daId + '/' + billId).remove()
                .then(() => alert("Bill Deleted!"))
                .catch(error => alert("Delete Failed: " + error.message));
            }
        }

        function cancelEdit() {
            editingBillId = null;
            document.getElementById('main_submit_btn').innerText = "Submit Bill";
            document.getElementById('main_submit_btn').classList.add('btn-success');
            document.getElementById('main_submit_btn').classList.remove('btn-warning');
            document.getElementById('cancel_edit_btn').classList.add('hidden');
            prepareBillEntryForm();
        }

        // ================= BILL HISTORY LOGIC =================
        function loadBills() {
            const tableBody = document.getElementById('bill_table_body');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

            const billsRef = database.ref('Bills');
            
            billsRef.on('value', (snapshot) => {
                tableBody.innerHTML = '';
                if (!snapshot.exists()) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">No Bills Found</td></tr>';
                    return;
                }

                snapshot.forEach((depotSnapshot) => {
                    depotSnapshot.forEach((daSnapshot) => {
                        daSnapshot.forEach((billSnapshot) => {
                            const bill = billSnapshot.val();
                            const billId = billSnapshot.key;
                            const daId = bill.daId; // Get DA ID

                            // Logic for Visibility
                            // Admin: See all EXCEPT 'draft'
                            // User: See own bills (including 'draft')
                            
                            if (currentUser.role === 'admin' && bill.status === 'draft') return;
                            if (currentUser.role === 'user' && bill.daId !== currentUser.id) return;

                            const tr = document.createElement('tr');
                            
                            // Add Class based on status
                            if(bill.status === 'draft') tr.classList.add('status-draft');
                            else if (bill.status === 'red') tr.classList.add('status-red');
                            else tr.classList.add('status-green');

                            // Amount Display
                            let amtHtml = '';
                            const deductedVal = bill.deduction || 0;
                            if (deductedVal > 0) {
                                const originalTotal = bill.totalAmount + deductedVal;
                                amtHtml = `<span class="cut-amount">${originalTotal}</span> <span class="payable-amount">${bill.totalAmount}</span>`;
                            } else {
                                amtHtml = bill.totalAmount;
                            }

                            // Status Text
                            let statusText = bill.status.toUpperCase();
                            if(bill.status === 'red') statusText = "PENDING";
                            
                            // Action Buttons
                            let actionBtns = '';
                            actionBtns += `<button class="btn btn-info btn-sm text-white" onclick="printBill('${billId}', '${bill.depot}', '${daId}')">Print</button> `;

                            // User Actions for Red/Draft Bills
                            if (currentUser.role === 'user' && (bill.status === 'red' || bill.status === 'draft')) {
                                actionBtns += `<button class="btn btn-warning btn-sm" onclick="editBill('${billId}', '${bill.depot}', '${daId}')">Edit</button> `;
                                actionBtns += `<button class="btn btn-danger btn-sm" onclick="deleteBill('${billId}', '${bill.depot}', '${daId}')">Del</button>`;
                            }

                            // Admin Actions
                            if (currentUser.role === 'admin' && bill.status === 'red') {
                                actionBtns += `<button class="btn btn-warning btn-sm" onclick="openCutModal('${billId}', '${bill.depot}', '${daId}', ${bill.totalAmount})">Cut</button>`;
                            }

                            tr.innerHTML = `
                                <td>${formatDate(bill.depDate)}</td>
                                <td>${bill.daName}</td>
                                <td>${bill.depot}</td>
                                <td>${bill.route || 'N/A'}</td>
                                <td>${amtHtml}</td>
                                <td><b>${statusText}</b></td>
                                <td>${actionBtns}</td>
                            `;
                            tableBody.appendChild(tr);
                        });
                    });
                });
            });
        }

        // ================= PRINT LOGIC =================
        function printBill(billId, depot, daId) {
            database.ref('Bills/' + depot + '/' + daId + '/' + billId).once('value', (snapshot) => {
                const bill = snapshot.val();
                if(!bill) return;

                let costPercent = "0%";
                if (bill.invoiceVal > 0) costPercent = ((bill.totalAmount / bill.invoiceVal) * 100).toFixed(2) + "%";

                document.getElementById('p_da_name').innerText = bill.daName;
                document.getElementById('p_depot').innerText = bill.depot;
                document.getElementById('p_dep_date').innerText = formatDate(bill.depDate);
                document.getElementById('p_ret_date').innerText = formatDate(bill.retDate);
                
                // Bill Submit Date
                const submitDate = new Date(bill.timestamp).toISOString().split('T')[0];
                document.getElementById('p_submit_date').innerText = formatDate(submitDate);

                document.getElementById('p_route').innerText = bill.route;
                document.getElementById('p_mpo').innerText = bill.mpo;
                document.getElementById('p_summary').innerText = bill.summaryNo;
                document.getElementById('p_inv_val').innerText = bill.invoiceVal;
                document.getElementById('p_ret_val').innerText = bill.returnVal;
                document.getElementById('p_sold_val').innerText = bill.soldVal;
                document.getElementById('p_inv_qty').innerText = bill.invoiceQty;
                document.getElementById('p_total_amount').innerText = bill.totalAmount;
                document.getElementById('p_total_words').innerText = numberToEnglish(bill.totalAmount) + " Taka Only";
                document.getElementById('p_cost_percent').innerText = costPercent;
                document.getElementById('p_prepared_by').innerText = bill.daName;

                const tbody = document.getElementById('p_expense_body');
                tbody.innerHTML = '';
                if(bill.expenses) {
                    bill.expenses.forEach(exp => {
                        if(!exp.date) return;
                        const amt = parseFloat(exp.amount) || 0;
                        const da = parseFloat(exp.da) || 0;
                        const ded = parseFloat(exp.deduction) || 0;
                        const total = (amt + da) - ded;
                        
                        tbody.innerHTML += `
                            <tr>
                                <td style="padding: 2px; text-align: left;">${formatDate(exp.date)}</td>
                                <td style="padding: 2px; text-align: left;">${exp.from}</td>
                                <td style="padding: 2px; text-align: left;">${exp.to}</td>
                                <td style="padding: 2px; text-align: left;">${exp.mode}</td>
                                <td style="padding: 2px; text-align: left;">${amt}</td>
                                <td style="padding: 2px; text-align: left;">${da}</td>
                                <td style="padding: 2px; text-align: left;">${ded}</td>
                                <td style="padding: 2px; text-align: left;">${total}</td>
                            </tr>
                        `;
                    });
                }
                window.print();
            });
        }

        function numberToEnglish(num) {
            if(num === 0) return "Zero";
            let a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
            let b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];
            if ((num = num.toString()).length > 9) return 'Overflow';
            let n = ('000000000' + num).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
            if (!n) return; 
            let str = '';
            str += (n[1] != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Crore ' : '';
            str += (n[2] != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Lakh ' : '';
            str += (n[3] != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Thousand ' : '';
            str += (n[4] != 0) ? (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) + 'Hundred ' : '';
            str += (n[5] != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[5])] || b[n[5][0]] + ' ' + a[n[5][1]]) : '';
            return str;
        }

        // ================= ADMIN DEDUCTION LOGIC =================
        function openCutModal(billId, depot, daId, amount) {
            document.getElementById('edit_bill_id').value = billId;
            document.getElementById('edit_depot').value = depot;
            document.getElementById('edit_depot').dataset.daId = daId; // Store DA ID
            
            database.ref('Bills/' + depot + '/' + daId + '/' + billId).once('value', (snapshot) => {
                const bill = snapshot.val();
                if(!bill) return;

                const tbody = document.getElementById('modal_expense_body');
                tbody.innerHTML = '';

                if(bill.expenses) {
                    bill.expenses.forEach(exp => {
                        const amt = parseFloat(exp.amount) || 0;
                        const da = parseFloat(exp.da) || 0;
                        const origTotal = amt + da;
                        const currentDeduction = parseFloat(exp.deduction) || 0;
                        const currentTotal = origTotal - currentDeduction;

                        const row = tbody.insertRow();
                        row.innerHTML = `
                            <td><input type="text" class="form-control form-control-sm" value="${formatDate(exp.date)}" disabled></td>
                            <td><input type="text" class="form-control form-control-sm" value="${exp.from}" disabled></td>
                            <td><input type="text" class="form-control form-control-sm" value="${exp.to}" disabled></td>
                            <td><input type="text" class="form-control form-control-sm" value="${exp.mode}" disabled></td>
                            <td><input type="number" class="form-control form-control-sm text-end row-amt" value="${amt}" disabled></td>
                            <td><input type="number" class="form-control form-control-sm text-end row-da" value="${da}" disabled></td>
                            <td><input type="number" class="form-control form-control-sm text-danger row-deduction" value="${currentDeduction}" placeholder="0" oninput="calculateModalTotals()"></td>
                            <td><span class="fw-bold row-total">${currentTotal}</span></td>
                        `;
                    });
                }
                calculateModalTotals();
            });
            new bootstrap.Modal(document.getElementById('cutBillModal')).show();
        }

        function calculateModalTotals() {
            let grandTotal = 0;
            document.querySelectorAll('#modal_expense_body tr').forEach(row => {
                const amt = parseFloat(row.querySelector('.row-amt').value) || 0;
                const da = parseFloat(row.querySelector('.row-da').value) || 0;
                const deduct = parseFloat(row.querySelector('.row-deduction').value) || 0;
                const rowTotal = (amt + da) - deduct;
                row.querySelector('.row-total').innerText = rowTotal;
                grandTotal += rowTotal;
            });
            document.getElementById('modal_grand_total').innerText = grandTotal;
        }

        function saveDeduction() {
            const billId = document.getElementById('edit_bill_id').value;
            const depot = document.getElementById('edit_depot').value;
            const daId = document.getElementById('edit_depot').dataset.daId; // Retrieve DA ID
            
            let newExpenses = [];
            let newTotalAmount = 0;
            let totalDeduction = 0;

            document.querySelectorAll('#modal_expense_body tr').forEach(row => {
                const date = row.cells[0].querySelector('input').value;
                const from = row.cells[1].querySelector('input').value;
                const to = row.cells[2].querySelector('input').value;
                const mode = row.cells[3].querySelector('input').value;
                const amt = row.querySelector('.row-amt').value;
                const da = row.querySelector('.row-da').value;
                const deduction = row.querySelector('.row-deduction').value || 0;
                const rowTotal = parseFloat(row.querySelector('.row-total').innerText);

                newExpenses.push({ date, from, to, mode, amount: amt, da, deduction });
                newTotalAmount += rowTotal;
                totalDeduction += parseFloat(deduction);
            });

            // Update using correct path
            database.ref('Bills/' + depot + '/' + daId + '/' + billId).update({
                expenses: newExpenses,
                totalAmount: newTotalAmount,
                deduction: totalDeduction,
                status: 'green'
            }, (error) => {
                if (error) alert("Failed");
                else {
                    alert("Payment Approved!");
                    bootstrap.Modal.getInstance(document.getElementById('cutBillModal')).hide();
                }
            });
        }

        // ================= ADD NEW DA =================
        function saveNewDA() {
            const name = document.getElementById('new_da_name').value;
            const depot = document.getElementById('new_da_depot').value;
            const username = document.getElementById('new_da_user').value;
            const password = document.getElementById('new_da_pass').value;

            if (!name || !username || !password) { alert("Fill all fields"); return; }

            const newUserRef = database.ref('Users').push();
            newUserRef.set({ name, depot, username, password, role: 'user' }, (error) => {
                if(error) alert("Error");
                else alert("DA Created!");
            });
        }
    </script>
</body>
</html>